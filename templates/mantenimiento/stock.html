{% extends "basebs.html" %}

{% block heading %}



    <script>
          $(function () {
               $(document).ready(function () {

                  let permisopcion='';
                  var listdatositems=[];

                  permisopcion = {
                        'acc': '{{ permisopcion.id }}'
                  };

                  function buscar(){
                       location.href = "/stock?acc={{ permisopcion.id }}&id="+{{ producto.id }};
                  }

                  eliminarFila=function (element) {
                        let fila = element.closest("tr");
                        if (fila) {
                            fila.remove();
                        }
                  }


                  var tablastock = new DataTable('#tablastock', {

                       language: {
                           "lengthMenu": "Mostrar _MENU_ registros",
                           "zeroRecords": "No existe información",
                           "info": "Mostrando _PAGE_ de _PAGES_",
                           "infoEmpty": "Sin datos",
                           "infoFiltered": "(Filtrando de un total de _MAX_ registros)",
                           "search": "Buscar",
                           "paginate": {
                               "previous": "Anterior",
                               "next": "Siguiente"
                           }
                       },
                       ajax: {
                           url: '/stock',
                           type: 'POST',
                           data: function (d) {
                               d.action = 'serverSide';
                               d.permisopcion = permisopcion;
                               d.idproducto=parseInt('{{ producto.id }}')
                           }
                       },
                       columns: [

                           {data: 'tamano', "orderable": true},
                           {data: 'color', "orderable": true,type: 'html'},
                           {data: 'precio', "orderable": true},
                           {data: 'cantidadexistente', "orderable": true},
                           {data: 'cantidadminima', "orderable": true},
                           {data: 'estado', type: 'html'},
                           {data: 'acciones', type: 'html'}
                       ],
                       processing: true,
                       serverSide: true,
                       fixedHeader: true,
                       searching: true,
                       search: true,
                       info: false,
                       initComplete: function () {
                           var table = this.api();
                           $('#' + 'tablastock' + '_filter').parent().addClass('d-none');
                           $('.filtro-columna', table.table().header()).each(function () {
                               const columnIndex = $(this).index();
                               const column = table.column(columnIndex);

                               if (!$(this).hasClass('sin-filtrado')) {
                                   // Filtro tipo SELECT si alguna clase comienza con "filtro-select"
                                   var classes = this.className.split(' ');
                                   var claseFiltro = classes.find(function (clase) {
                                       return clase.includes('filtro-select');
                                   });
                                   if ([...this.classList].some(c => c.startsWith('filtro-select'))) {
                                       const select = $('<select class="form-select form-select-sm form-control-filter"><option value="">Todos</option></select>')
                                           .on('change', function () {
                                               const val = $.fn.dataTable.util.escapeRegex($(this).val());
                                               column.search(val, false, false).draw();
                                           });

                                       const json = table.ajax.json();
                                       const opciones = json?.[claseFiltro] || [];


                                       select.empty().append('<option value="">Seleccione</option>');
                                       for (const opt of opciones) {
                                           select.append(`<option value="${opt.id}">${opt.nombre}</option>`);
                                       }

                                       $(this).html(select);

                                       select.select2({
                                           width: '100%',  // Se adapta al ancho del <th>
                                           placeholder: "Seleccione",
                                           allowClear: true
                                       });

                                   } else {
                                       // Filtro tipo INPUT
                                       const input = $('<input type="text" class="form-control form-control-sm form-control-filter" placeholder="Filtrar...">')
                                           .on('keyup change', function () {
                                               column.search($(this).val()).draw();
                                           });

                                       $(this).html(input);
                                   }
                               }
                           });

                           table.columns.adjust();
                       }
                   });

                   tablastock.on('draw.dt', function () {
                       tablastock.columns.adjust();
                   });

                   function elimimarfeedback(tabSelector) {
                        const tab = document.querySelector(tabSelector);
                        const fields = tab.querySelectorAll('input[required], select[required], textarea[required]');
                        for (let field of fields) {
                            field.classList.remove("is-invalid");
                            let feedback = field.parentElement.querySelector('.invalid-feedback');
                            if (feedback) {
                                feedback.textContent = "";
                                feedback.style.display = 'none';
                            }
                        }
                        return true
                  }

                  function validarCamposDeTab(tabSelector) {
                        const tab = document.querySelector(tabSelector);
                        const fields = tab.querySelectorAll('input[required], select[required], textarea[required]');
                        let valido = true;

                        for (let field of fields) {
                            const isVisible = field.offsetParent !== null;

                            if (isVisible && (!field.value || field.value === "0")) {
                                field.classList.add("is-invalid");

                                let feedback = field.parentElement.querySelector('.invalid-feedback');
                                if (!feedback) {
                                    feedback = document.createElement('div');
                                    feedback.className = 'invalid-feedback';
                                    field.parentElement.appendChild(feedback);
                                }

                                feedback.textContent = "Este campo es obligatorio.";
                                feedback.style.display = 'block';

                                setTimeout(() => field.focus(), 300);  // evitar error de no focusable
                                valido = false;
                                break;
                            } else {
                                field.classList.remove("is-invalid");
                                let feedback = field.parentElement.querySelector('.invalid-feedback');
                                if (!feedback) {
                                     feedback = document.createElement('div');
                                     feedback.className = 'invalid-feedback';
                                     field.parentElement.appendChild(feedback);
                                }
                                feedback.textContent = "";
                                feedback.style.display = 'none';
                                const nombreCampo = field.id;
                                if (nombreCampo === 'txtidentificacion') {
                                    if ($("#cmbtipoidentificacion").val()==1){

                                        if(!validarCedula($("#txtidentificacion").val())) {
                                            feedback.textContent = "La cédula del representante no es válida.";
                                            feedback.style.display = 'block';
                                            valido = false;
                                            break;
                                        }

                                    }else {
                                         if(!validarRuc($("#txtidentificacion").val())) {
                                            feedback.textContent = "El RUC ingresado no es válido.";
                                            feedback.style.display = 'block';
                                            valido = false;
                                            break;
                                         }
                                    }
                                }

                            }
                        }

                        return valido;
                }

                  function validarTabsEnOrden(...tabs) {
                        for (let tabId of tabs) {
                            const tabLink = document.querySelector(`button[data-bs-target="${tabId}"]`);
                            if (tabLink) {
                                const tab = new bootstrap.Tab(tabLink);
                                tab.show();
                            } else {
                                console.warn(`No se encontró tab link para ${tabId}`);
                             }
                            if (!validarCamposDeTab(tabId)) {
                                return false;
                            }
                        }

                        return true;
                  }

                  function EliminarTabsEnOrden(...tabs) {
                        for (let tabId of tabs) {
                           elimimarfeedback(tabId)
                        }
                        return true;
                  }


                   $("#btnagregar").click(function() {
                       $("#tituloventana").html("Ingresar Stock");

                       $("#ventanastock").modal({backdrop: 'static', keyboard: false});
                       $("#ventanastock").modal("show");
                  });

                  $("#btncancelar").click(function() {
                     document.getElementById("frmingresostock").reset();
                     $("#ventanastock").modal('hide');
                  });

                  $("#btnagregardetalle").click(function() {
                       $("#ventanadetallestock").modal({backdrop: 'static', keyboard: false});
                       $("#ventanadetallestock").modal("show");
                  });

                  $("#btncancelardetalle").click(function() {
                     document.getElementById("frmingresodetallestock").reset();
                     EliminarTabsEnOrden('#frmingresodetallestock')
                     $("#ventanadetallestock").modal('hide');
                  });


                  $('#frmingresodetallestock').on('submit', function(e) {
                      e.preventDefault();
                      if (validarTabsEnOrden('#frmingresodetallestock')) {

                          document.getElementById("tabladetallestock").innerHTML += `
                                <tr>
                                    <td hidden>${$("#cmbtamano").val()}</td>
                                    <td>
                                        <span class="btn"
                                              style="background:${$("#txtcolor").val()}; color:white; cursor:context-menu;"
                                              data-bgcolor="#FA1D06"
                                              data-color="#ffffff">
                                        </span>
                                        ${$("#txtcolor").val()}
                                    </td>
                                    <td>${$("#txtprecio").val()}</td>
                                    <td>
                                        ${$("#txtcantidad").val()}
                                        <div style="float:right;">
                                            <a class="btn btn-sm btn-icon text-danger" data-bs-toggle="tooltip" title="Eliminar item" onclick="eliminarFila(this)">
                                                <span class="btn-inner">
                                                    <svg class="icon-20" width="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
                                                        <path d="M19.3248 9.46826C19.3248 9.46826 18.7818 16.2033 18.4668 19.0403C18.3168 20.3953 17.4798 21.1893 16.1088 21.2143C13.4998 21.2613 10.8878 21.2643 8.27979 21.2093C6.96079 21.1823 6.13779 20.3783 5.99079 19.0473C5.67379 16.1853 5.13379 9.46826 5.13379 9.46826" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path d="M20.708 6.23975H3.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path d="M17.4406 6.23973C16.6556 6.23973 15.9796 5.68473 15.8256 4.91573L15.5826 3.69973C15.4326 3.13873 14.9246 2.75073 14.3456 2.75073H10.1126C9.53358 2.75073 9.02558 3.13873 8.87558 3.69973L8.63258 4.91573C8.47858 5.68473 7.80258 6.23973 7.01758 6.23973" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                `;
                          document.getElementById("frmingresodetallestock").reset();
                          $("#ventanadetallestock").modal("hide");
                      }
                 });

                function datosDetalleItems() {
                    listdatositems=[];
                    for (var i = 0; i < document.getElementById('tabladetallestock').rows.length; i++) {
                        let celdaCantidad = document.getElementById('tabladetallestock').rows[i].cells[3];
                        let cantidad = celdaCantidad.childNodes[0].textContent.trim();
                        listdatositems.push({
                            "color": document.getElementById('tabladetallestock').rows[i].cells[1].innerText.trim(),
                            "precio": document.getElementById('tabladetallestock').rows[i].cells[2].innerText.trim(),
                            "cantidad": cantidad
                        });
                    }
                }

                $('#frmingresostock').on('submit', function(e) {
                      e.preventDefault();
                      if (validarTabsEnOrden('#frmingresostock') ) {
                           if (document.getElementById('tabladetallestock').rows.length > 0) {

                              Loader.open();
                              datosDetalleItems();
                              const formData = new FormData(this);
                              formData.append('action', 'agregar');
                              formData.append('idproducto', parseInt('{{ producto.id }}'));
                              formData.append('listadatositems', JSON.stringify(listdatositems));
                              formData.append('id', 0);


                              $.ajax({
                                  url: '/stock',
                                  type: "POST",
                                  contentType: false,
                                  data: formData,
                                  processData: false,
                                  cache: false,
                                  success: function (data) {
                                      if (data.result == "ok") {

                                          swal("! Stock", "Se ingreso correctamente", "success").then((result) => {
                                              buscar();
                                          });

                                      } else {
                                          swal("Error", data.message, "error");
                                      }
                                  },
                                  error: function (xhr, ajaxOptions, thrownError) {
                                      swal("Error", "Error Conexion en el Servidor", "error");
                                  },
                                  complete: function () {
                                      Loader.close();
                                  }

                              });

                           }else{
                               swal("Stock","debe ingesar al menos un item al detalle","warning")
                           }


                      }
                 });

                 eliminarStock = function (id,nombre) {

                      swal({
                        title: '¿Está seguro que desea eliminar el stock?',
                        text: "Tamaño : "+nombre,
                        type: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Si,Eliminar!',
                        cancelButtonText: 'Cancelar',
                        confirmButtonClass: 'btn btn-success me-2',
                        cancelButtonClass: 'btn btn-danger ',
                        buttonsStyling: false,
                        allowOutsideClick: false

                        }).then(function (isConfirm) {

                                if (isConfirm['dismiss']!='cancel' && isConfirm['dismiss']!='esc') {

                                    Loader.open();
                                    var formData = new FormData();
                                    formData.append('action', 'eliminar');
                                    formData.append('id', id);

                                    $.ajax({
                                        url: '/stock',
                                        type: "POST",
                                        contentType: false,
                                        data: formData,
                                        processData: false,
                                        cache: false,
                                        success: function (data) {
                                            if (data.result == "ok") {
                                                swal("! Stock","Se eliminó correctamente", "success").then((result) => {
                                                 buscar();
                                                });

                                            } else {
                                                swal("Error", data.message, "error");

                                            }

                                        }, error: function (xhr, ajaxOptions, thrownError) {
                                            swal("Error", "Error Conexion en el Servidor", "error");

                                        },

                                        complete: function () {
                                             Loader.close();
                                        }
                                    });

                                }
                      })


                  }





               });

          });
    </script>

{% endblock %}

{% block canvas %}

    <div class="col-sm-12">
         <div class="card">
            <div class="card-header d-flex justify-content-between">
               <div class="header-title">
                  <h4 class="card-title">Stock</h4>
                  <h5 class="card-title"> Producto: <strong> {{  producto.nombre }}</strong></h5>
               </div>
            </div>
            <div class="card-body">
                <div class="row d-flex justify-content-end">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                        <button type="button" class="btn btn-primary" id="btnagregar">Agregar</button>
                        <a class="btn btn-danger" href="/producto?acc={{ permisopcion.id }}" >Regresar</a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="tablastock" class="table table-striped"   >
                         <thead>
                            <tr>
                               <th>Tamaño</th>
                               <th>Color</th>
                               <th style="min-width: 10px;">Precio</th>
                               <th>Cantidad Existente</th>
                               <th>Cantidad Minima</th>
                               <th>Estado</th>
                               <th style="align-content: center">...</th>
                            </tr>
                             <tr>
                                <th class="filtro-columna filtro-select-tamano"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                                <th class="filtro-columna sin-filtrado"></th>
                            </tr>
                         </thead>
                    </table>
                </div>
            </div>
         </div>
    </div>

    <div class="modal fade" id="ventanastock" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tituloventana" >Ingresar Stock</h5>
          </div>
          <div class="modal-body">
             <div class="card-body">
               <form id="frmingresostock" novalidate method="post">
                    <div class="row">
                       <div class="col-sm-12 col-md-12 col-lg-12">
                           <div class="form-group">
                                <label class="form-label">Tamaño :</label>
                                <select id="cmbtamano" name="cmbtamano" class="form-select form-select mb-3 shadow-none" required>
                                    <option value="0">Seleccionar el tamaño</option>
                                     {% for xlistatamano in listatamano %}
                                           <option value='{{ xlistatamano.id }}'>{{ xlistatamano.nombre }}</option>
                                     {% endfor %}
                                </select>
                            </div>
                       </div>
                    </div>
                    <div class="row d-flex justify-content-end">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <button type="button" class="btn btn-info" id="btnagregardetalle">Agregar Detalle</button>
                        </div>
                    </div> <br>

                    <div class="row">
                         <div class="col-sm-12 col-md-12 col-lg-12">
                            <table class="table">
                              <thead>
                                <tr>
                                  <th scope="col" hidden>Tamaño</th>
                                  <th scope="col">Color</th>
                                  <th scope="col">Precio</th>
                                  <th scope="col">Cantidad</th>
                                </tr>
                              </thead>
                              <tbody id="tabladetallestock">

                              </tbody>
                            </table>
                         </div>
                    </div>

                   <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btncancelar">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnguardar">Guardar</button>
                  </div>
               </form>
             </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal fade" id="ventanadetallestock" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tituloventanadetalla" >Ingresar Detalle</h5>
          </div>
          <div class="modal-body">
             <div class="card-body">
               <form id="frmingresodetallestock" novalidate method="post">

                    <div class="row">
                       <div class="col-sm-12 col-md-12 col-lg-12">
                            <div class="form-group">
                                <label class="form-label" >Color:</label>
                                <input type="color" class="form-control" id="txtcolor" value="#50b5ff" required>
                            </div>
                       </div>
                    </div>

                   <div class="row">
                       <div class="col-sm-6 col-md-6 col-lg-6">
                            <div class="form-group">
                                <label class="form-label" >Precio:</label>
                                <input type="number" class="form-control" id="txtprecio"  min="1" max="100" required>
                            </div>
                       </div>
                       <div class="col-sm-6 col-md-6 col-lg-6">
                            <div class="form-group">
                                <label class="form-label" >Cantidad:</label>
                                <input type="number" class="form-control" id="txtcantidad" min="1" max="1000"  required>
                            </div>
                       </div>
                   </div>

                   <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btncancelardetalle">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnguardardetalle">Guardar</button>
                   </div>

               </form>
             </div>
          </div>

        </div>
      </div>
    </div>


{% endblock %}